/*
* Teletype jQuery Plugin
* @version 0.2-alpha
*
* @author Steve Whiteley
* @see http://teletype.rocks
* @see https://github.com/stvwhtly/jquery-teletype-plugin
*
* Copyright (c) 2014 Steve Whiteley
* Dual licensed under the MIT or GPL Version 2 licenses.
*
*/
!function(t){t.fn.teletype=function(e){var n=t.extend({},t.fn.teletype.defaults,e),i=t(this),o=null,s={string:"",index:0,position:0,loop:0,tag:[]},a=function(){return s.tag=[],s.index++,s.index>=n.text.length&&(s.index=0,s.loop++,n.loop!==!1&&n.loop==s.loop)?!1:(s.position=0,s.string=n.text[s.index],!0)},r=function(){n.prefix&&0==s.position&&0==s.loop&&0==s.index&&t("<span />").addClass("teletype-prefix").html(n.prefix).prependTo(i);var e=s.string.split(""),u=e[s.position];if("^"==u||"~"==u){var h=s.string.substr(s.position+1).indexOf(" "),c=s.string.substr(s.position+1,h);if(t.isNumeric(c)){if(s.string=s.string.replace(u+c+" ",""),"^"==u)window.setTimeout(function(){window.setTimeout(r,g(n.typeDelay))},c);else{var d=s.position-c;s.string=s.string.substr(0,d-1)+s.string.substr(s.position-1),window.setTimeout(function(){l(Math.max(d,0))},g(n.backDelay))}return}}else if("\\"==u){var f=s.string.substr(s.position+1,1);"n"==f&&(s.position++,u="<br />")}else if(n.html===!0)if("<"==u){var m=s.string.substr(s.position).match(/^(<(?:\/)?(\w+)\s?(.*?)(\/)?>).*(?=<\/\2>)?/i);if(m&&m[2])return s.string=s.string.replace(m[1],""),t(m[1]).appendTo(s.tag.length>0?t(s.tag[s.tag.length-1],o).not(".teletype-cursor").last():o),m[2].match(/^(area|br|col|embed|hr|img|input|link|meta|param)$/)||("/"==m[1].substr(1,1)&&s.tag[s.tag.length-1]==m[2]?s.tag.pop():m[4]||(s.tag[s.tag.length]=m[2])),r()}else if("&"==u){var m=s.string.substr(s.position).match(/^(&\w+;)/i);m&&(u=m[1],s.string=s.string.replace(m[1],""),s.position=s.position-2)}void 0!=u&&(s.tag.length>0?(p(t(s.tag[s.tag.length-1],o)),t(s.tag[s.tag.length-1],o).not(".teletype-cursor").last().append(u)):n.html===!0?(o.append(u),p(i)):o.text(o.text()+u),s.position++),s.position<s.string.length?window.setTimeout(r,g(n.typeDelay)):n.preserve===!1?window.setTimeout(function(){window.setTimeout(l,g(n.backDelay))},n.delay):(o.html(o.html()+'<br /><span class="teletype-prefix">'+n.prefix+"</span>"),a()&&window.setTimeout(function(){window.setTimeout(r,g(n.typeDelay))},n.delay))},l=function(e){if(e||(e=0),s.position>e){var u=-1;if(n.html===!0){var h=t("<div />").html(o.html()).html();if(s.tag.length>0){p(i);var c=t(s.tag[s.tag.length-1],o).last();if(h=c.html(),""==h)return c.remove(),s.tag.pop(),s.position++,l(e)}if(">"==h.substr(h.length-1)){var d=h.match(/([\/])?(\w+)>$/i);d&&d[1]&&(s.tag[s.tag.length]=d[2])}else if(";"==h.substr(h.length-1)){var d=h.match(/(&\w+;)$/i);console.log(d),d&&d[1]&&(u=-1*d[1].length)}}s.tag.length>0?(t(s.tag[s.tag.length-1],o).not(".teletype-cursor").last().html(function(t,e){return e.slice(0,u)}),p(t(s.tag[s.tag.length-1],o))):(n.html===!0&&p(i),o.html(o.html().slice(0,u))),s.position--,window.setTimeout(function(){l(e)},g(n.backDelay))}else{if(0==e&&a()===!1)return;window.setTimeout(r,g(n.typeDelay))}},p=function(e){t(".teletype-cursor",i).detach().appendTo(e.not(".teletype-cursor").last())},g=function(t){var e=parseInt(t);return n.humanise&&(e+=Math.floor(200*Math.random())),e};return this.each(function(){if(s.string=n.text[s.index],i.addClass("teletype").empty(),o=t("<span />").addClass("teletype-text").appendTo(i),n.cursor){var e=t("<span />").text(n.cursor).addClass("teletype-cursor").appendTo(i);setInterval(function(){e.animate({opacity:0}).animate({opacity:1})},n.blinkSpeed)}r()})},t.fn.teletype.defaults={text:["one","two","three"],typeDelay:100,backDelay:50,blinkSpeed:1e3,delay:2e3,cursor:"|",preserve:!1,prefix:"",loop:0,humanise:!0,html:!1}}(jQuery);
